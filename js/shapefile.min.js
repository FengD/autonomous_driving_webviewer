(function(p,l){"object"===typeof exports&&"undefined"!==typeof module?l(exports):"function"===typeof define&&define.amd?define(["exports"],l):l(p.shapefile={})})(this,function(p){function l(a){return new x(a instanceof Uint8Array?a:new Uint8Array(a))}function x(a){this._array=a}function r(a){return("function"===typeof fetch?P:Q)(a)}function t(a){return"function"===typeof a.read?a:a.getReader()}function A(a){return"function"===typeof a.slice?a:new w("function"===typeof a.read?a:a.getReader())}function w(a){this._source=
a;this._array=y;this._index=0}function B(a,b,c,d){this._source=a;this._decode=b.decode.bind(b);this._recordLength=c.getUint16(10,!0);this._fields=[];for(a=0;13!==d.getUint8(a);a+=32){for(b=0;11>b&&0!==d.getUint8(a+b);++b);this._fields.push({name:this._decode(new Uint8Array(d.buffer,d.byteOffset+a,b)),type:String.fromCharCode(d.getUint8(a+11)),length:d.getUint8(a+16)})}}function C(a){if(4>(c=a.length))return!1;for(var b=0,c,d=a[c-1][1]*a[0][0]-a[c-1][0]*a[0][1];++b<c;)d+=a[b-1][1]*a[b][0]-a[b-1][0]*
a[b][1];return 0<=d}function D(a,b){for(var c=-1,d=b.length,e;++c<d;){a:{e=a;for(var g=b[c],h=g[0],k=g[1],f=-1,z=0,E=e.length,l=E-1;z<E;l=z++){var m=e[z],p=m[0],q=m[1],n=e[l];l=n[0];var r=n[1];var u=g[0]-m[0];var t=g[1]-m[1];if(0===u&&0===t)u=!0;else{var v=n[0]-m[0];m=n[1]-m[1];0===v&&0===m?u=!1:(n=(u*v+t*m)/(v*v+m*m),u=0>n||1<n?!1:0===n||1===n?!0:n*v===u&&n*m===t)}if(u){e=0;break a}q>k!==r>k&&h<(l-p)*(k-q)/(r-q)+p&&(f=-f)}e=f}if(e)return 0<e}return!1}function F(a,b){var c=b.getInt32(32,!0);if(!(c in
G))throw Error("unsupported shape type: "+c);this._source=a;this._type=c;this._index=0;this._parse=G[c];this.bbox=[b.getFloat64(36,!0),b.getFloat64(44,!0),b.getFloat64(52,!0),b.getFloat64(60,!0)]}function S(){}function H(a,b){this._shp=a;this._dbf=b;this.bbox=a.bbox}function I(a,b,c){"string"===typeof b?(/\.dbf$/.test(b)||(b+=".dbf"),b=r(b,c)):b instanceof ArrayBuffer||b instanceof Uint8Array?b=l(b):null!=b&&(b=t(b));"string"===typeof a?(/\.shp$/.test(a)||(a+=".shp"),void 0===b&&(b=r(a.substring(0,
a.length-4)+".dbf",c).catch(function(){})),a=r(a,c)):a=a instanceof ArrayBuffer||a instanceof Uint8Array?l(a):t(a);return Promise.all([a,b]).then(function(a){var b=a[0];a=a[1];var d="windows-1252";c&&null!=c.encoding&&(d=c.encoding);return T(b,a,a&&new TextDecoder(d))})}x.prototype.read=function(){var a=this._array;this._array=null;return Promise.resolve(a?{done:!1,value:a}:{done:!0,value:void 0})};x.prototype.cancel=function(){this._array=null;return Promise.resolve()};var P=function(a){return fetch(a).then(function(a){return a.body&&
a.body.getReader?a.body.getReader():a.arrayBuffer().then(l)})},Q=function(a){return new Promise(function(b,c){var d=new XMLHttpRequest;d.responseType="arraybuffer";d.onload=function(){b(l(d.response))};d.onerror=c;d.ontimeout=c;d.open("GET",a,!0);d.send()})},y=new Uint8Array(0);w.prototype.read=function(){var a=this,b=a._array.subarray(a._index);return a._source.read().then(function(c){a._array=y;a._index=0;if(c.done)c=0<b.length?{done:!1,value:b}:{done:!0,value:void 0};else{c=c.value;if(b.length)if(c.length){var d=
new Uint8Array(b.length+c.length);d.set(b);d.set(c,b.length);c=d}else c=b;c={done:!1,value:c}}return c})};w.prototype.slice=function(a){if(0>(a|=0))throw Error("invalid length");var b=this,c=this._array.length-this._index;if(this._index+a<=this._array.length)return Promise.resolve(this._array.subarray(this._index,this._index+=a));var d=new Uint8Array(a);d.set(this._array.subarray(this._index));return function g(){return b._source.read().then(function(h){if(h.done)return b._array=y,b._index=0,0<c?
d.subarray(0,c):null;if(c+h.value.length>=a)return b._array=h.value,b._index=a-c,d.set(h.value.subarray(0,a-c),c),d;d.set(h.value,c);c+=h.value.length;return g()})}()};w.prototype.cancel=function(){return this._source.cancel()};var f=function(a){return!(a=a.trim())||isNaN(a=+a)?null:a},U={B:f,C:function(a){return a.trim()||null},D:function(a){return new Date(+a.substring(0,4),a.substring(4,6)-1,+a.substring(6,8))},F:f,L:function(a){return/^[nf]$/i.test(a)?!1:/^[yt]$/i.test(a)?!0:null},M:f,N:f},q=
function(a){return new DataView(a.buffer,a.byteOffset,a.byteLength)},J=function(a,b){a=A(a);return a.slice(32).then(function(c){var d=q(c);return a.slice(d.getUint16(8,!0)-32).then(function(c){return new B(a,b,d,q(c))})})};f=B.prototype;f.read=function(){var a=this,b=1;return a._source.slice(a._recordLength).then(function(c){return c&&26!==c[0]?{done:!1,value:a._fields.reduce(function(d,e){d[e.name]=U[e.type](a._decode(c.subarray(b,b+=e.length)));return d},{})}:{done:!0,value:void 0}})};f.cancel=
function(){return this._source.cancel()};f=function(a){var b=40,c,d=a.getInt32(36,!0),e=Array(d);for(c=0;c<d;++c,b+=16)e[c]=[a.getFloat64(b,!0),a.getFloat64(b+8,!0)];return{type:"MultiPoint",coordinates:e}};var K=function(a){return{type:"Point",coordinates:[a.getFloat64(4,!0),a.getFloat64(12,!0)]}},L=function(a){var b=44,c,d=a.getInt32(36,!0),e=a.getInt32(40,!0),g=Array(d),h=Array(e),k=[],f=[];for(c=0;c<d;++c,b+=4)g[c]=a.getInt32(b,!0);for(c=0;c<e;++c,b+=16)h[c]=[a.getFloat64(b,!0),a.getFloat64(b+
8,!0)];g.forEach(function(a,b){a=h.slice(a,g[b+1]);C(a)?k.push([a]):f.push(a)});f.forEach(function(a){k.some(function(b){if(D(b[0],a))return b.push(a),!0})||k.push([a])});return 1===k.length?{type:"Polygon",coordinates:k[0]}:{type:"MultiPolygon",coordinates:k}},M=function(a){var b=44,c,d=a.getInt32(36,!0),e=a.getInt32(40,!0),g=Array(d),h=Array(e);for(c=0;c<d;++c,b+=4)g[c]=a.getInt32(b,!0);for(c=0;c<e;++c,b+=16)h[c]=[a.getFloat64(b,!0),a.getFloat64(b+8,!0)];return 1===d?{type:"LineString",coordinates:h}:
{type:"MultiLineString",coordinates:g.map(function(a,b){return h.slice(a,g[b+1])})}},N=function(a,b){var c=new Uint8Array(a.length+b.length);c.set(a,0);c.set(b,a.length);return c},G={0:function(){return null},1:K,3:M,5:L,8:f,11:function(a){return{type:"PointZ",coordinates:[a.getFloat64(4,!0),a.getFloat64(12,!0),a.getFloat64(20,!0)]}},13:function(a){var b=0,c=44,d,e=a.getInt32(36,!0),g=a.getInt32(40,!0),h=Array(e),k=Array(g);for(d=0;d<e;++d,c+=4)h[d]=a.getInt32(c,!0);b=c+16*g+16;for(d=0;d<g;++d,c+=
16,b+=8)k[d]=[a.getFloat64(c,!0),a.getFloat64(c+8,!0),a.getFloat64(b,!0)];return 1===e?{type:"LineString",coordinates:k}:{type:"MultiLineString",coordinates:h.map(function(a,b){return k.slice(a,h[b+1])})}},15:function(a){var b=0,c=44,d;b=a.getInt32(36,!0);var e=a.getInt32(40,!0),g=Array(b),h=Array(e),k=[],f=[];for(d=0;d<b;++d,c+=4)g[d]=a.getInt32(c,!0);b=c+16*e+16;for(d=0;d<e;++d,c+=16)h[d]=[a.getFloat64(c,!0),a.getFloat64(c+8,!0),a.getFloat64(b+8,!0)];g.forEach(function(a,b){a=h.slice(a,g[b+1]);
C(a)?k.push([a]):f.push(a)});f.forEach(function(a){k.some(function(b){if(D(b[0],a))return b.push(a),!0})||k.push([a])});return 1===k.length?{type:"Polygon",coordinates:k[0]}:{type:"MultiPolygon",coordinates:k}},18:function(a){var b=40,c,d=a.getInt32(36,!0),e=Array(d);for(c=0;c<d;++c,b+=24)e[c]=[a.getFloat64(b,!0),a.getFloat64(b+8,!0),a.getFloat64(b+16,!0)];return{type:"MultiPoint",coordinates:e}},21:K,23:M,25:L,28:f},O=function(a){a=A(a);return a.slice(100).then(function(b){return new F(a,q(b))})};
f=F.prototype;f.read=function(){var a=this;++a._index;return a._source.slice(12).then(function(b){function c(){return a._source.slice(4).then(function(g){if(null==g)return{done:!0,value:void 0};e=q(b=N(b.slice(4),g));return e.getInt32(0,!1)!==a._index?c():d()})}function d(){var d=2*e.getInt32(4,!1)-4,f=e.getInt32(8,!0);return 0>d||f&&f!==a._type?c():a._source.slice(d).then(function(c){return{done:!1,value:f?a._parse(q(N(b.slice(8),c))):null}})}if(null==b)return{done:!0,value:void 0};var e=q(b);return d()})};
f.cancel=function(){return this._source.cancel()};var T=function(a,b,c){return Promise.all([O(a),b&&J(b,c)]).then(function(a){return new H(a[0],a[1])})};f=H.prototype;f.read=function(){return Promise.all([this._dbf?this._dbf.read():{value:{}},this._shp.read()]).then(function(a){var b=a[0];a=a[1];return a.done?a:{done:!1,value:{type:"Feature",properties:b.value,geometry:a.value}}})};f.cancel=function(){return Promise.all([this._dbf&&this._dbf.cancel(),this._shp.cancel()]).then(S)};p.open=I;p.openShp=
function(a,b){"string"===typeof a?(/\.shp$/.test(a)||(a+=".shp"),a=r(a,b)):a=a instanceof ArrayBuffer||a instanceof Uint8Array?l(a):t(a);return Promise.resolve(a).then(O)};p.openDbf=function(a,b){var c="windows-1252";b&&null!=b.encoding&&(c=b.encoding);c=new TextDecoder(c);"string"===typeof a?(/\.dbf$/.test(a)||(a+=".dbf"),a=r(a,b)):a=a instanceof ArrayBuffer||a instanceof Uint8Array?l(a):t(a);return Promise.resolve(a).then(function(a){return J(a,c)})};p.read=function(a,b,c){return I(a,b,c).then(function(a){var b=
[],c={type:"FeatureCollection",features:b,bbox:a.bbox};return a.read().then(function R(d){if(d.done)return c;b.push(d.value);return a.read().then(R)})})};Object.defineProperty(p,"__esModule",{value:!0})});